{% extends 'admin/admin_base.html' %}

{% block title %}Edit Blog Post{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}

<div class="admin-wrapper">

  <!-- Sidebar -->
  {% include 'partials/admin_nav.html' %}

  <!-- Main Content -->
  <main class="admin-main">
    <!-- Top Row -->
    <div class="admin-topbar">
      <div class="page-title">
        <h2>Edit Blog Post</h2>
      </div>
      <div class="user-info">
        <a class="btn-select" href="{{ url_for('main.admin_blog_post') }}">‚Üê Back to list</a>
        <span class="user-email">admin@atlantalocals</span>
        <span class="user-avatar">üë§</span>
      </div>
    </div>

    <!-- Content Form -->
    <div class="admin-content-container">
      <div class="content-card">

        {# Current image URL if provided #}
        {% set current_img = (image_url|default('')) or (post and post.image and url_for('static', filename=post.image)) %}

        <form method="POST"
              action="{{ url_for('main.admin_blog_detail', post_id=(post.post_id if post else post_id)) }}"
              enctype="multipart/form-data"
              id="blog-read-update-form">

          {{ post_form.hidden_tag() }}
          {{ content_form.hidden_tag() }}

          <!-- Title -->
          <div class="form-group">
            {{ post_form.title.label }}
            {{ post_form.title(id='title', class_='') }}
            {% for e in post_form.title.errors %}<small class="error">{{ e }}</small>{% endfor %}
          </div>

          <!-- Slug -->
          <div class="form-group">
            {{ post_form.slug.label }}
            {{ post_form.slug(id='slug', class_='') }}
            {% for e in post_form.slug.errors %}<small class="error">{{ e }}</small>{% endfor %}
          </div>

          <!-- Category -->
          <div class="form-group">
            <label for="blog_cat_id">Category</label>
            {{ post_form.blog_cat_id(id='blog_cat_id', class_='') }}
            {% for e in post_form.blog_cat_id.errors %}<small class="error">{{ e }}</small>{% endfor %}
          </div>

          <!-- Author -->
          <div class="form-group">
            <label for="author_id">Author</label>
            {{ post_form.author_id(id='author_id', class_='') }}
            {% for e in post_form.author_id.errors %}<small class="error">{{ e }}</small>{% endfor %}
          </div>

          <!-- Image -->
          <div class="form-group">
            <label>Featured Image</label>
            <div style="display:flex; gap:16px; align-items:flex-start;">
              <img id="image-preview"
                   src="{{ current_img or '' }}"
                   alt="Current image"
                   style="max-width:220px; max-height:140px; object-fit:cover; border:1px solid #eee; border-radius:8px; background:#f8f8f8;">
              <div style="display:flex; flex-direction:column; gap:8px;">
                {{ post_form.image(id='image', accept='image/*') }}
                <small id="image-path-note" style="color:#666;">
                  If you choose a new file, it will replace the current image on update.
                </small>
                {% for e in post_form.image.errors %}<small class="error">{{ e }}</small>{% endfor %}
              </div>
            </div>
          </div>

          <!-- YouTube (optional) -->
          <div class="form-group">
            <label for="yt_vid_id">YouTube Video ID (optional)</label>
            {{ content_form.yt_vid_id(id='yt_vid_id') }}
            {% for e in content_form.yt_vid_id.errors %}<small class="error">{{ e }}</small>{% endfor %}
          </div>

          <!-- Content (flattened to match BlogContent fields) -->
          <div class="form-group" id="content-sections">
            <h3>Content</h3>

            <!-- Section 1 -->
            <div class="content-section" data-section="section-1">
              <h4>Section 1</h4>
              {{ content_form.section_1_title.label }}
              {{ content_form.section_1_title(id='section1-title') }}
              {{ content_form.section_1_paragraph_1.label }}
              {{ content_form.section_1_paragraph_1(id='section1-paragraph1', rows='3') }}
              {{ content_form.section_1_paragraph_2.label }}
              {{ content_form.section_1_paragraph_2(id='section1-paragraph2', rows='3') }}
              {{ content_form.section_1_paragraph_3.label }}
              {{ content_form.section_1_paragraph_3(id='section1-paragraph3', rows='3') }}
            </div>

            <!-- Section 2 -->
            <div class="content-section" data-section="section-2">
              <h4>Section 2</h4>
              {{ content_form.section_2_title.label }}
              {{ content_form.section_2_title(id='section2-title') }}
              {{ content_form.section_2_paragraph_1.label }}
              {{ content_form.section_2_paragraph_1(id='section2-paragraph1', rows='3') }}
              {{ content_form.section_2_paragraph_2.label }}
              {{ content_form.section_2_paragraph_2(id='section2-paragraph2', rows='3') }}
              {{ content_form.section_2_paragraph_3.label }}
              {{ content_form.section_2_paragraph_3(id='section2-paragraph3', rows='3') }}
            </div>

            <!-- Section 3 -->
            <div class="content-section" data-section="section-3">
              <h4>Section 3</h4>
              {{ content_form.section_3_title.label }}
              {{ content_form.section_3_title(id='section3-title') }}
              {{ content_form.section_3_paragraph_1.label }}
              {{ content_form.section_3_paragraph_1(id='section3-paragraph1', rows='3') }}
              {{ content_form.section_3_paragraph_2.label }}
              {{ content_form.section_3_paragraph_2(id='section3-paragraph2', rows='3') }}
              {{ content_form.section_3_paragraph_3.label }}
              {{ content_form.section_3_paragraph_3(id='section3-paragraph3', rows='3') }}
            </div>

            <!-- Section 4 -->
            <div class="content-section" data-section="section-4">
              <h4>Section 4</h4>
              {{ content_form.section_4_title.label }}
              {{ content_form.section_4_title(id='section4-title') }}
              {{ content_form.section_4_paragraph_1.label }}
              {{ content_form.section_4_paragraph_1(id='section4-paragraph1', rows='3') }}
              {{ content_form.section_4_paragraph_2.label }}
              {{ content_form.section_4_paragraph_2(id='section4-paragraph2', rows='3') }}
              {{ content_form.section_4_paragraph_3.label }}
              {{ content_form.section_4_paragraph_3(id='section4-paragraph3', rows='3') }}
            </div>

            <!-- Section 5 -->
            <div class="content-section" data-section="section-5">
              <h4>Section 5</h4>
              {{ content_form.section_5_title.label }}
              {{ content_form.section_5_title(id='section5-title') }}
              {{ content_form.section_5_paragraph_1.label }}
              {{ content_form.section_5_paragraph_1(id='section5-paragraph1', rows='3') }}
              {{ content_form.section_5_paragraph_2.label }}
              {{ content_form.section_5_paragraph_2(id='section5-paragraph2', rows='3') }}
              {{ content_form.section_5_paragraph_3.label }}
              {{ content_form.section_5_paragraph_3(id='section5-paragraph3', rows='3') }}
            </div>

            <!-- Section 6 Conclusion -->
            <div class="content-section" data-section="section-6-conclusion">
              <h4>Section 6 ‚Äî Conclusion</h4>
              {{ content_form.section_6_conclusion_title.label }}
              {{ content_form.section_6_conclusion_title(id='section6-title') }}
              {{ content_form.section_6_conclusion_paragraph_1.label }}
              {{ content_form.section_6_conclusion_paragraph_1(id='section6-paragraph1', rows='3') }}
              {{ content_form.section_6_conclusion_paragraph_2.label }}
              {{ content_form.section_6_conclusion_paragraph_2(id='section6-paragraph2', rows='3') }}
              {{ content_form.section_6_conclusion_paragraph_3.label }}
              {{ content_form.section_6_conclusion_paragraph_3(id='section6-paragraph3', rows='3') }}
            </div>

            <!-- Section 7 Assoc. Press -->
            <div class="content-section" data-section="section-7-assoc-press">
              <h4>Section 7 ‚Äî Associated Press</h4>
              {{ content_form.section_7_assoc_press_title.label }}
              {{ content_form.section_7_assoc_press_title(id='section7-title') }}
              {{ content_form.section_7_assoc_press_paragraph_1.label }}
              {{ content_form.section_7_assoc_press_paragraph_1(id='section7-paragraph1', rows='3') }}
            </div>

            <!-- Section 8 ‚Äî FAQs (Q1‚ÄìQ3 required) -->
            <div class="content-section" data-section="section-8-faqs">
              <h4>Section 8 ‚Äî FAQs</h4>

              <div class="faq-item">
                {{ content_form.faq_q_1.label }} {{ content_form.faq_q_1() }}
                {{ content_form.faq_a_1.label }} {{ content_form.faq_a_1(rows='3') }}
              </div>
              <div class="faq-item">
                {{ content_form.faq_q_2.label }} {{ content_form.faq_q_2() }}
                {{ content_form.faq_a_2.label }} {{ content_form.faq_a_2(rows='3') }}
              </div>
              <div class="faq-item">
                {{ content_form.faq_q_3.label }} {{ content_form.faq_q_3() }}
                {{ content_form.faq_a_3.label }} {{ content_form.faq_a_3(rows='3') }}
              </div>
              <div class="faq-item">
                {{ content_form.faq_q_4.label }} {{ content_form.faq_q_4() }}
                {{ content_form.faq_a_4.label }} {{ content_form.faq_a_4(rows='3') }}
              </div>
              <div class="faq-item">
                {{ content_form.faq_q_5.label }} {{ content_form.faq_q_5() }}
                {{ content_form.faq_a_5.label }} {{ content_form.faq_a_5(rows='3') }}
              </div>
              <div class="faq-item">
                {{ content_form.faq_q_6.label }} {{ content_form.faq_q_6() }}
                {{ content_form.faq_a_6.label }} {{ content_form.faq_a_6(rows='3') }}
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="form-group" style="display:flex; gap:12px; flex-wrap:wrap;">
            <button type="submit" class="btn-select" id="btn-update">Update</button>
            <a class="btn-select" id="btn-cancel" href="{{ url_for('main.admin_blog_post') }}">Cancel</a>
            <a class="btn-select" href="{{ url_for('main.admin_blog_post') }}">Back to list</a>
          </div>
        </form>

        <!-- Delete Form (same endpoint, action=delete) -->
        <form method="POST"
              action="{{ url_for('main.admin_blog_detail', post_id=(post.post_id if post else post_id)) }}"
              id="delete-form"
              style="margin-top:8px;">
          {{ post_form.csrf_token }}
          <input type="hidden" name="action" value="delete">
          <button type="submit"
                  class="btn-danger"
                  style="background:#d9534f; color:#fff;"
                  id="btn-delete"
                  onclick="return confirm('Delete this post? This cannot be undone.');">
            Delete
          </button>
        </form>

      </div>
    </div>
  </main>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  {# CRUD is handled server-side via WTForms; no client CRUD JS needed #}
{% endblock %}
